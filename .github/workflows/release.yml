name: Build and Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Required to create releases and upload assets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for changelog generation

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build Client Release
        run: |
          msbuild "StarRupture-ModLoader.sln" `
            /p:Configuration="Client Release" `
            /p:Platform=x64 `
            /p:PostBuildEventUseInBuild=false `
            /m `
            /v:minimal

      - name: Build Server Release
        run: |
          msbuild "StarRupture-ModLoader.sln" `
            /p:Configuration="Server Release" `
            /p:Platform=x64 `
            /p:PostBuildEventUseInBuild=false `
            /m `
            /v:minimal

      - name: Stage release layout
        shell: pwsh
        run: |
          foreach ($target in @("Client", "Server")) {
            $config  = "$target Release"
            $staging = "$env:GITHUB_WORKSPACE\staging\$target"
            $modsDir = "$staging\alienx_mods"

            New-Item -ItemType Directory -Force -Path $staging | Out-Null
            New-Item -ItemType Directory -Force -Path $modsDir | Out-Null

            # version.dll goes in the root
            Copy-Item "build\$config\version.dll" "$staging\version.dll"

            # Copy every .dll found in alienx_mods - no exp/lib files
            Get-ChildItem "build\$config\alienx_mods\*.dll" | ForEach-Object {
              Copy-Item $_.FullName $modsDir
              Write-Host "Staged [$target]: $($_.Name)"
            }
          }

      - name: Generate release tag
        id: tag
        shell: pwsh
        run: |
          $tag = "release-$(Get-Date -Format 'yyyy.MM.dd-HHmmss')"
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        shell: pwsh
        run: |
          # Find the previous release tag
          $prevTag = git tag --sort=-creatordate | Select-Object -First 1

          if ($prevTag) {
            Write-Host "Generating changelog since tag: $prevTag"
            $log = git log "$prevTag..HEAD" --pretty=format:"- %s (%an)" --no-merges
          } else {
            Write-Host "No previous tag found - listing all commits"
            $log = git log --pretty=format:"- %s (%an)" --no-merges
          }

          if (-not $log) {
            $log = "- No changes listed"
          }

          # Write to a file to safely pass multiline content
          $log | Out-File -FilePath "$env:GITHUB_WORKSPACE\changelog.txt" -Encoding utf8
          Write-Host "Changelog:"
          Write-Host $log

      - name: Create ZIP archives
        shell: pwsh
        run: |
          $tag = "${{ steps.tag.outputs.TAG }}"
          foreach ($target in @("Client", "Server")) {
            $zipPath = "$env:GITHUB_WORKSPACE\StarRupture-ModLoader-$target-$tag.zip"
            Compress-Archive -Path "$env:GITHUB_WORKSPACE\staging\$target\*" -DestinationPath $zipPath
            Write-Host "Created ZIP: $zipPath"
          }

      - name: Create GitHub Release
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag       = "${{ steps.tag.outputs.TAG }}"
          $changelog = Get-Content "$env:GITHUB_WORKSPACE\changelog.txt" -Raw
          $clientZip = "$env:GITHUB_WORKSPACE\StarRupture-ModLoader-Client-$tag.zip"
          $serverZip = "$env:GITHUB_WORKSPACE\StarRupture-ModLoader-Server-$tag.zip"

          $notes = @"
          ## What's New

          $changelog
          "@

          gh release create $tag $clientZip $serverZip `
            --title "StarRupture ModLoader $tag" `
            --notes $notes
